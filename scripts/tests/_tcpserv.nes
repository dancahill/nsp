#!/usr/bin/nesla
if (type(expect)!='function') include("_expect.nes");
function testtcpd() {
	if (type(tcp)!='table') {
		print("SKIPPING TCPSERV TESTS\n");
		return;
	}
	if (type(tcp.open)=='function') {
		bsock=tcp.bind("localhost", 1234);
		print("bsock=", type(bsock), "\n");
		io.flush();
		while (1) {
			asock=tcp.accept(bsock);
			if (type(asock)=='sock4') {
				x=tcp.gets(asock);
				print("client said: ", x, "\n");
				if (x=="ping") {
					tcp.write(asock, "pong\r\n");
					print("i said: pong\n");
				} else {
					tcp.write(asock, "expected pong\r\n");
					print("i said: expected pong\n");
				}
				io.flush();
				tcp.close(asock);
			}
		}
		tcp.close(bsock);
	}

	return;
}
testtcpd();
